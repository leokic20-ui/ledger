<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ledger.OS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link rel="apple-touch-icon" href="icon.png"> 
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <style>
        html, body { 
            height: 100%; 
            width: 100%; 
            margin: 0; 
            overflow: hidden; 
            position: fixed; 
        }
        
        body { 
            background-color: #1a1a1a; 
            color: #ffffff; 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif; 
            -webkit-tap-highlight-color: transparent; 
        }

        * { touch-action: manipulation; }
        
        .custom-scroll {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-y: contain;
        }
        .custom-scroll::-webkit-scrollbar { display: none; }

        .neo-card { background-color: #262626; border: 2px solid #333; box-shadow: 4px 4px 0px 0px #000; border-radius: 12px; }
        .sticker-btn { background-color: #FF9900; color: black; border: 2px solid black; box-shadow: 4px 4px 0px 0px #000; font-weight: 900; text-transform: uppercase; }
        .sticker-btn:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0px 0px #000; }
        .hidden-date-input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; z-index: 10; }
        input, select { background: #1a1a1a; color: white; border: 2px solid #333; outline: none; border-radius: 8px; }
        input:focus { border-color: #FF9900; }
        .pop-enter-active, .pop-leave-active { transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .pop-enter-from { opacity: 0; transform: scale(0.95); }
        .pop-leave-to { opacity: 0; transform: scale(1.05); display: none; }
        
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        .safe-pt { padding-top: env(safe-area-inset-top); }
    </style>
</head>
<body class="flex flex-col w-full">

<div id="app" class="flex flex-col h-full w-full max-w-md mx-auto relative overflow-hidden">

    <!-- HEADER -->
    <header class="safe-pt px-4 pt-4 pb-2 flex justify-between items-center bg-[#1a1a1a] border-b-2 border-[#333] z-20 shrink-0">
        <h1 class="text-xl font-black italic">LEDGER<span class="text-[#FF9900]">.OS</span></h1>
        <div class="flex items-center gap-2 bg-[#262626] px-2 py-1 rounded border border-[#333]">
            <div :class="syncStatusColor" class="w-2 h-2 rounded-full animate-pulse"></div>
            <span class="text-[10px] text-gray-400 font-mono">{{ displayUid }}</span>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-1 custom-scroll p-4 pb-28 relative">
        <transition name="pop" mode="out-in">
            
            <!-- VIEW 1: CALENDAR -->
            <div v-if="currentView === 'calendar'" key="cal" class="space-y-4">
                <div class="neo-card p-2 flex justify-between items-center bg-[#262626] relative">
                    <button @click="changeMonth(-1)" class="p-2 text-[#FF9900] font-black text-lg z-20">‚óÄ</button>
                    <div class="relative flex-1 flex justify-center items-center h-full">
                        <span class="font-black text-xl tracking-wide border-b-2 border-dashed border-[#FF9900] pb-1">{{ formatYearMonth(currentDate) }}</span>
                        <input type="month" :value="currentYearMonthStr" @input="onMonthPick" class="hidden-date-input">
                    </div>
                    <button @click="changeMonth(1)" class="p-2 text-[#FF9900] font-black text-lg z-20">‚ñ∂</button>
                </div>
                <div class="neo-card p-2 bg-[#1a1a1a]">
                    <div class="grid grid-cols-7 mb-2 text-center text-[10px] text-gray-500 font-bold"><div v-for="d in ['S','M','T','W','T','F','S']">{{ d }}</div></div>
                    <div class="grid grid-cols-7 gap-1">
                        <div v-for="n in startDayOfWeek" :key="'empty'+n" class="h-10"></div>
                        <div v-for="day in daysInMonth" :key="day.dateStr" @click="selectDate(day.dateStr)" class="h-10 relative flex items-center justify-center rounded-lg border border-transparent transition-all active:scale-90" :class="dayClass(day)">
                            <span class="text-sm font-bold z-10">{{ day.dayNum }}</span>
                            <div v-if="hasTransaction(day.dateStr)" class="absolute bottom-1 w-1 h-1 rounded-full bg-[#FF9900]"></div>
                        </div>
                    </div>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between items-end border-b border-[#333] pb-1 px-1">
                        <span class="text-xs font-bold text-gray-400">{{ selectedDate }}</span>
                        <span class="font-mono font-bold text-[#FF9900]">${{ dayTotal }}</span>
                    </div>
                    <div v-if="filteredTransactions.length === 0" class="text-center py-6 text-gray-600 text-xs">No records.</div>
                    <div v-for="t in filteredTransactions" :key="t.id" @click="editTransaction(t)" class="neo-card p-3 flex justify-between items-center active:scale-[0.98]">
                        <div class="flex items-center gap-3">
                            <span class="text-xl">{{ getCategoryIcon(t.category) }}</span>
                            <div>
                                <div class="font-bold text-sm flex items-center gap-1">
                                    {{ t.category }}
                                    <!-- Ê®ôË®òËá™ÂãïÁîüÊàêÁöÑÈ†ÖÁõÆ -->
                                    <span v-if="t.fixedItemId" class="text-[8px] bg-[#333] px-1 rounded text-gray-400 border border-gray-600">AUTO</span>
                                </div>
                                <div class="text-[10px] text-gray-500">{{ t.account }} <span v-if="t.note">/ {{ t.note }}</span></div>
                            </div>
                        </div>
                        <div :class="['font-mono font-bold', t.type === 'expense' ? 'text-white' : 'text-[#FF9900]']">{{ t.type === 'expense' ? '-' : '+' }}{{ t.amount }}</div>
                    </div>
                </div>
            </div>

            <!-- VIEW 2: ACCOUNTS -->
            <div v-else-if="currentView === 'accounts'" key="acc" class="space-y-4">
                <button @click="openFilterModal" class="w-full neo-card p-3 flex justify-between items-center bg-[#262626] active:scale-[0.98]">
                    <div class="flex items-center gap-2 text-[#FF9900]">
                        <span class="text-lg">üìÖ</span>
                        <span class="font-bold text-xs">{{ formatDateRange(filterRange) }}</span>
                    </div>
                    <div class="text-[10px] bg-[#333] px-2 py-1 rounded border border-gray-600">FILTER</div>
                </button>
                <div class="neo-card p-5 bg-gradient-to-br from-[#FF9900] to-[#cc7a00] text-black border-none">
                    <div class="text-[10px] font-black uppercase tracking-widest opacity-80">Net Worth (Selected Period)</div>
                    <div class="text-4xl font-black font-mono mt-2">${{ netWorthFiltered }}</div>
                </div>
                <div class="grid gap-3">
                     <div class="text-[10px] text-gray-500 font-bold uppercase ml-1">Current Wallet Balances (All Time)</div>
                    <div v-for="acc in accounts" :key="acc.name" class="neo-card p-4 flex justify-between items-center bg-[#262626]">
                        <div class="flex items-center gap-3"><span class="text-2xl">{{ acc.icon }}</span><span class="font-bold">{{ acc.name }}</span></div>
                        <span class="font-mono text-lg font-bold">${{ getAccountBalance(acc.name) }}</span>
                    </div>
                </div>
            </div>

            <!-- VIEW 3: CHARTS -->
            <div v-else-if="currentView === 'charts'" key="chart" class="space-y-4">
                <button @click="openFilterModal" class="w-full neo-card p-3 flex justify-between items-center bg-[#262626] active:scale-[0.98]">
                    <div class="flex items-center gap-2 text-[#FF9900]">
                        <span class="text-lg">üìÖ</span>
                        <span class="font-bold text-xs">{{ formatDateRange(filterRange) }}</span>
                    </div>
                    <div class="text-[10px] bg-[#333] px-2 py-1 rounded border border-gray-600">FILTER</div>
                </button>
                
                <div class="grid grid-cols-2 gap-2">
                    <div class="neo-card p-2 bg-[#262626] flex flex-col items-center justify-center">
                        <span class="text-[9px] text-gray-500 font-bold uppercase">Total Expense</span>
                        <span class="text-lg font-mono font-black text-white">${{ totalExpenseFiltered }}</span>
                    </div>
                    <div class="neo-card p-2 bg-[#262626] flex flex-col items-center justify-center">
                        <span class="text-[9px] text-gray-500 font-bold uppercase">Daily Average</span>
                        <span class="text-lg font-mono font-black text-[#FF9900]">${{ dailyAverage }}</span>
                    </div>
                </div>

                <div class="neo-card p-4 bg-[#262626] h-72 relative flex items-center justify-center">
                    <div v-show="categoryStats.length === 0" class="text-gray-500 font-bold text-sm absolute">NO DATA FOR THIS PERIOD</div>
                    <canvas v-show="categoryStats.length > 0" :key="chartKey" ref="chartRef" class="w-full h-full"></canvas>
                </div>
                
                <div class="space-y-2 pb-4">
                    <div v-for="(stat, index) in categoryStats" :key="stat.name" class="flex justify-between items-center p-2 border-b border-[#333]">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full shadow" :style="{backgroundColor: chartColors[index % chartColors.length]}"></div>
                            <span class="text-xl">{{ stat.icon }}</span><span class="font-bold text-xs">{{ stat.name }}</span>
                        </div>
                        <div class="font-mono text-sm font-bold flex gap-2">
                            <span>${{ stat.total }}</span>
                            <span class="text-[#FF9900]">({{ stat.percent }}%)</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW 4: SETTINGS -->
            <div v-else-if="currentView === 'settings'" key="set" class="space-y-6">
                <div class="neo-card p-4 bg-[#262626]">
                    <h3 class="text-[#FF9900] font-black text-sm mb-3 uppercase flex items-center gap-2"><span>üîÑ</span> Fixed Monthly Items</h3>
                    <div v-for="(item, idx) in fixedItems" :key="idx" class="flex justify-between items-center bg-[#1a1a1a] p-2 rounded mb-2 border border-[#333]">
                        <div>
                            <div class="font-bold text-xs">{{ item.category }} (${{ item.amount }})</div>
                            <div class="text-[10px] text-gray-500">Auto-adds on 1st of month ({{ item.startMonth }} ‚ûù {{ item.endMonth || 'Forever' }})</div>
                        </div>
                        <button @click="removeFixedItem(idx)" class="text-red-500 font-bold px-2">√ó</button>
                    </div>
                    <div class="mt-3 pt-3 border-t border-[#333] space-y-2">
                        <div class="flex gap-2">
                            <select v-model="newFixed.type" class="w-1/3 text-xs p-2"><option value="expense">Exp</option><option value="income">Inc</option></select>
                            <input v-model.number="newFixed.amount" placeholder="$" class="w-2/3 text-xs p-2 font-mono">
                        </div>
                        <div class="flex gap-2">
                            <select v-model="newFixed.category" class="w-full text-xs p-2"><option v-for="c in categories" :value="c.name">{{ c.name }}</option></select>
                        </div>
                        <div class="flex gap-2 items-center"><span class="text-[10px] text-gray-500 w-10">FROM</span><input v-model="newFixed.startMonth" type="month" class="flex-1 text-xs p-2 font-mono"></div>
                        <div class="flex gap-2 items-center"><span class="text-[10px] text-gray-500 w-10">TO</span><input v-model="newFixed.endMonth" type="month" class="flex-1 text-xs p-2 font-mono"></div>
                        <input v-model="newFixed.note" placeholder="Note (Optional)" class="w-full text-xs p-2">
                        <button @click="addFixedItem" class="sticker-btn bg-[#333] text-white w-full py-2 text-xs rounded mt-2">ADD RULE</button>
                    </div>
                </div>
                <div class="neo-card p-4 bg-[#262626]">
                    <button @click="exportJSON" class="sticker-btn bg-[#333] text-white w-full py-3 rounded font-bold text-sm">EXPORT JSON BACKUP</button>
                    <div class="text-[10px] text-gray-600 text-center mt-2 font-mono">UID: {{ displayUid }}</div>
                </div>
            </div>
        </transition>
    </main>

    <!-- FAB -->
    <button @click="openAddModal" class="absolute bottom-24 right-5 w-16 h-16 rounded-full sticker-btn flex items-center justify-center z-30 text-4xl pb-1">+</button>

    <!-- NAV -->
    <nav class="safe-pb bg-[#1a1a1a] border-t-2 border-[#333] h-20 shrink-0 flex justify-around items-center z-20 w-full">
        <button v-for="v in ['calendar', 'accounts', 'charts', 'settings']" @click="currentView = v" class="flex flex-col items-center justify-center w-16 h-full transition-all active:scale-90">
            <span class="text-2xl mb-1 filter drop-shadow-md" :class="currentView === v ? 'opacity-100 scale-110' : 'opacity-40 grayscale'">{{ {calendar:'üìÖ', accounts:'üí≥', charts:'üìä', settings:'‚öôÔ∏è'}[v] }}</span>
            <span class="text-[9px] font-black uppercase tracking-wider" :class="currentView === v ? 'text-[#FF9900]' : 'text-gray-600'">{{ v }}</span>
        </button>
    </nav>

    <!-- DATE FILTER MODAL -->
    <div v-if="showFilterModal" class="fixed inset-0 bg-black/90 z-50 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-[#1a1a1a] w-full max-w-sm rounded-xl border-2 border-[#FF9900] p-4 space-y-4 card-shadow">
            <h3 class="font-black text-lg text-[#FF9900]">SELECT DATE RANGE</h3>
            <div class="grid grid-cols-2 gap-2">
                <button @click="setFilterPreset('thisMonth')" class="p-2 border border-[#333] rounded text-xs font-bold active:bg-[#333]">This Month</button>
                <button @click="setFilterPreset('lastMonth')" class="p-2 border border-[#333] rounded text-xs font-bold active:bg-[#333]">Last Month</button>
                <button @click="setFilterPreset('thisYear')" class="p-2 border border-[#333] rounded text-xs font-bold active:bg-[#333]">This Year</button>
                <button @click="setFilterPreset('lastYear')" class="p-2 border border-[#333] rounded text-xs font-bold active:bg-[#333]">Last Year</button>
            </div>
            <div class="space-y-2 pt-2 border-t border-[#333]">
                <div class="text-xs text-gray-500 font-bold">CUSTOM RANGE</div>
                <div class="flex gap-2">
                    <input v-model="tempFilter.start" type="date" class="flex-1 p-2 text-xs font-mono">
                    <input v-model="tempFilter.end" type="date" class="flex-1 p-2 text-xs font-mono">
                </div>
            </div>
            <button @click="applyFilter" class="sticker-btn w-full py-3 rounded">APPLY FILTER</button>
            <button @click="showFilterModal = false" class="text-xs text-gray-500 w-full py-2">CANCEL</button>
        </div>
    </div>

    <!-- ADD/EDIT MODAL -->
    <div v-if="showModal" class="fixed inset-0 bg-black/90 z-50 flex items-end justify-center backdrop-blur-sm safe-pb">
        <div @click="closeModal" class="absolute inset-0"></div>
        <div class="bg-[#1a1a1a] w-full max-w-md rounded-t-3xl border-t-4 border-[#FF9900] p-5 space-y-3 relative card-shadow mb-4 mx-2">
            
            <div class="flex justify-between items-center">
                <h3 class="font-black text-xl italic">{{ isEditing ? 'EDIT' : 'NEW' }} ENTRY</h3>
                <button @click="closeModal" class="text-xl text-gray-500 w-6 h-6 flex items-center justify-center bg-[#262626] rounded-full">√ó</button>
            </div>
            
            <div class="flex bg-[#262626] p-1 rounded-xl border border-[#333] h-10">
                <button @click="form.type = 'expense'" :class="['flex-1 rounded-lg font-black text-xs transition-all flex items-center justify-center', form.type === 'expense' ? 'bg-[#333] text-white shadow-sm' : 'text-gray-500']">EXPENSE</button>
                <button @click="form.type = 'income'" :class="['flex-1 rounded-lg font-black text-xs transition-all flex items-center justify-center', form.type === 'income' ? 'bg-[#333] text-[#FF9900] shadow-sm' : 'text-gray-500']">INCOME</button>
            </div>
            
            <div class="relative">
                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-[#FF9900] font-black text-xl">$</span>
                <input v-model.number="form.amount" type="number" inputmode="decimal" placeholder="0" class="w-full py-3 pl-8 pr-4 text-3xl font-mono font-bold rounded-xl text-right bg-[#262626] border-2 border-[#333] focus:border-[#FF9900]">
            </div>
            
            <div class="grid grid-cols-4 gap-2 py-1">
                <button v-for="cat in categories" @click="form.category = cat.name" :class="['flex flex-col items-center justify-center p-2 rounded-xl border-2 transition-all active:scale-95 h-16', form.category === cat.name ? 'border-[#FF9900] bg-[#262626]' : 'border-transparent bg-[#1a1a1a]']">
                    <span class="text-xl mb-1">{{ cat.icon }}</span>
                    <span class="text-[8px] font-bold uppercase truncate w-full text-center">{{ cat.name }}</span>
                </button>
            </div>
            
            <div class="grid grid-cols-2 gap-3">
                <select v-model="form.account" class="p-2 rounded-xl font-bold text-xs uppercase bg-[#262626] h-10"><option v-for="acc in accounts" :value="acc.name">{{ acc.name }}</option></select>
                <input v-model="form.date" type="date" class="p-2 rounded-xl font-mono text-xs bg-[#262626] h-10">
            </div>
            
            <input v-model="form.note" type="text" placeholder="Add a note..." class="w-full p-3 rounded-xl text-xs bg-[#262626]">
            
            <div class="flex gap-3 pt-1">
                <button v-if="isEditing" @click="deleteTransaction" class="flex-1 py-3 bg-red-900/30 text-red-500 font-black rounded-xl border-2 border-red-900 active:scale-95 transition-transform text-xs">DEL</button>
                <button @click="saveTransaction" class="flex-[2] py-3 bg-[#FF9900] text-black font-black rounded-xl border-2 border-black shadow-[4px_4px_0px_black] active:translate-y-1 active:shadow-none transition-all text-sm">CONFIRM</button>
            </div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyAgQ5MJpg6r6fo94OWGgQVQcqa--awmNVY",
      authDomain: "my-ledger-app-3e089.firebaseapp.com",
      projectId: "my-ledger-app-3e089",
      storageBucket: "my-ledger-app-3e089.firebasestorage.app",
      messagingSenderId: "119116668732",
      appId: "1:119116668732:web:df7a535b9ec4b25a8ec839"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

    const getHKDate = (d = new Date()) => {
        const offset = d.getTimezoneOffset() * 60000;
        return new Date(d.getTime() - offset).toISOString().split('T')[0];
    };

    createApp({
        setup() {
            const currentView = ref('calendar');
            const currentDate = ref(new Date());
            const selectedDate = ref(getHKDate());
            const transactions = ref([]);
            const userId = ref(null);
            const syncStatusColor = ref('bg-red-500');
            const showModal = ref(false);
            const isEditing = ref(false);
            const editingId = ref(null);
            const fixedItems = ref([]);
            const chartRef = ref(null);
            const chartKey = ref(0); 
            
            const showFilterModal = ref(false);
            const today = new Date();
            const startOfMonth = getHKDate(new Date(today.getFullYear(), today.getMonth(), 1));
            const endOfMonth = getHKDate(new Date(today.getFullYear(), today.getMonth() + 1, 0));
            const filterRange = ref({ start: startOfMonth, end: endOfMonth });
            const tempFilter = ref({ ...filterRange.value });

            const newFixed = ref({ type: 'expense', amount: '', category: 'Food', note: '', startMonth: '', endMonth: '' });
            const chartColors = ['#FF9900', '#00CED1', '#FF69B4', '#9370DB', '#4169E1', '#FFD700', '#32CD32', '#FF4500'];
            const accounts = ref([{ name: 'Bank', icon: 'üè¶' }, { name: 'Cash', icon: 'üíµ' }, { name: 'Credit', icon: 'üí≥' }, { name: 'Octopus', icon: 'üêô' }]);
            
            // Êñ∞Â¢û Household È°ûÂà•
            const categories = [
                { name: 'Food', icon: 'üçî' }, 
                { name: 'Transport', icon: 'üöå' }, 
                { name: 'Shopping', icon: 'üõçÔ∏è' }, 
                { name: 'Ent.', icon: 'üé¨' }, 
                { name: 'Bills', icon: 'üßæ' }, 
                { name: 'Household', icon: 'üè†' }, // Êñ∞Â¢û
                { name: 'Salary', icon: 'üí∞' }, 
                { name: 'Travel', icon: '‚úàÔ∏è' }, 
                { name: 'Health', icon: 'üíä' }
            ];
            const form = ref({ type: 'expense', amount: '', category: 'Food', account: 'Cash', date: '', note: '' });

            const displayUid = computed(() => userId.value ? userId.value.substring(0,6) : 'OFFLINE');
            const currentYearMonthStr = computed(() => getHKDate(currentDate.value).slice(0, 7));
            const startDayOfWeek = computed(() => { const d = new Date(currentDate.value); d.setDate(1); return d.getDay(); });
            const daysInMonth = computed(() => {
                const year = currentDate.value.getFullYear();
                const month = currentDate.value.getMonth();
                const days = new Date(year, month + 1, 0).getDate();
                return Array.from({length: days}, (_, i) => ({ dayNum: i + 1, dateStr: getHKDate(new Date(year, month, i + 1)) }));
            });
            const filteredTransactions = computed(() => transactions.value.filter(t => t.date === selectedDate.value));
            const dayTotal = computed(() => filteredTransactions.value.reduce((s, t) => t.type === 'expense' ? s - t.amount : s + t.amount, 0));
            
            const transactionsInFilterRange = computed(() => {
                return transactions.value.filter(t => t.date >= filterRange.value.start && t.date <= filterRange.value.end);
            });
            const netWorthFiltered = computed(() => transactionsInFilterRange.value.reduce((s, t) => t.type === 'income' ? s + t.amount : s - t.amount, 0));
            
            const categoryStats = computed(() => {
                const s = {};
                transactionsInFilterRange.value.filter(t => t.type === 'expense').forEach(t => { s[t.category] = (s[t.category] || 0) + t.amount; });
                const total = Object.values(s).reduce((a, b) => a + b, 0);
                return Object.entries(s).map(([n, v]) => ({ name: n, total: v, icon: categories.find(c => c.name === n)?.icon || '?', percent: total ? Math.round(v/total*100) : 0 })).sort((a,b) => b.total - a.total);
            });
            
            const totalExpenseFiltered = computed(() => categoryStats.value.reduce((sum, item) => sum + item.total, 0));
            const dailyAverage = computed(() => {
                if (!filterRange.value.start || !filterRange.value.end) return 0;
                const start = new Date(filterRange.value.start);
                const end = new Date(filterRange.value.end);
                const diffTime = Math.abs(end - start) + 86400000;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays > 0 ? Math.round(totalExpenseFiltered.value / diffDays) : 0;
            });

            const closeModal = () => showModal.value = false;
            const formatDateRange = (r) => `${r.start} ‚ûù ${r.end}`;
            const openFilterModal = () => { tempFilter.value = { ...filterRange.value }; showFilterModal.value = true; };
            const applyFilter = () => { filterRange.value = { ...tempFilter.value }; showFilterModal.value = false; };
            
            const setFilterPreset = (type) => {
                const now = new Date();
                let s, e;
                if (type === 'thisMonth') {
                    s = new Date(now.getFullYear(), now.getMonth(), 1);
                    e = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                } else if (type === 'lastMonth') {
                    s = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    e = new Date(now.getFullYear(), now.getMonth(), 0);
                } else if (type === 'thisYear') {
                    s = new Date(now.getFullYear(), 0, 1);
                    e = new Date(now.getFullYear(), 11, 31);
                } else if (type === 'lastYear') {
                    s = new Date(now.getFullYear() - 1, 0, 1);
                    e = new Date(now.getFullYear() - 1, 11, 31);
                }
                const newRange = { start: getHKDate(s), end: getHKDate(e) };
                return newRange;
            };

            const addFixedItem = async () => { 
                if (!newFixed.value.amount || !newFixed.value.startMonth) return alert("Start Month required!"); 
                await db.collection('users').doc(userId.value).collection('fixedItems').add(newFixed.value); 
                newFixed.value = { type: 'expense', amount: '', category: 'Food', note: '', startMonth: '', endMonth: '' };
                alert("Auto-rule added. It will trigger on the 1st of each month.");
            };

            const saveTransaction = async () => {
                if (!form.value.amount || !userId.value) return;
                const d = { ...form.value };
                try {
                    if (isEditing.value) await db.collection('users').doc(userId.value).collection('transactions').doc(editingId.value).update(d);
                    else await db.collection('users').doc(userId.value).collection('transactions').add(d);
                    closeModal();
                } catch (e) { alert(e.message); }
            };
            const deleteTransaction = async () => { if (confirm("Delete?")) { await db.collection('users').doc(userId.value).collection('transactions').doc(editingId.value).delete(); closeModal(); } };
            const removeFixedItem = async (idx) => await db.collection('users').doc(userId.value).collection('fixedItems').doc(fixedItems.value[idx].id).delete();
            const exportJSON = () => { const a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([JSON.stringify(transactions.value, null, 2)], { type: "application/json" })); a.download = `ledger_backup.json`; a.click(); };

            // Ëá™ÂãïÊ™¢Êü•Âõ∫ÂÆöÈ†ÖÁõÆÈÇèËºØ (Ê†∏ÂøÉÂäüËÉΩ)
            const checkFixedItems = async () => {
                if (!userId.value || fixedItems.value.length === 0) return;
                
                const now = new Date();
                const currentMonthStr = getHKDate(now).slice(0, 7); // "2024-01"
                const firstDayOfCurrentMonth = `${currentMonthStr}-01`;

                // Âè™Êúâ‰ªäÂ§© >= 1ËôüÊâçÂü∑Ë°å (ÂÖ∂ÂØ¶ÊØèÂ§©ÈÉΩÂèØ‰ª•Ê™¢Êü•ÔºåÂõ†ÁÇ∫ÊàëÂÄëÊúÉÁî® ID Èò≤Ê≠¢ÈáçË§á)
                // ÈÄôË£°ÊàëÂÄëÁ∞°ÂñÆÈªûÔºåÂè™Ë¶ÅÊâìÈñã App Â∞±Ê™¢Êü•‰∏ÄÈÅç
                
                for (const item of fixedItems.value) {
                    // 1. Ê™¢Êü•Êó•ÊúüÁØÑÂúçÊòØÂê¶ÊúâÊïà
                    if (currentMonthStr < item.startMonth) continue; // Â∞öÊú™ÈñãÂßã
                    if (item.endMonth && currentMonthStr > item.endMonth) continue; // Â∑≤Á∂ìÁµêÊùü

                    // 2. Ê™¢Êü•Êú¨ÊúàÊòØÂê¶Â∑≤Á∂ìÁî¢ÁîüÈÅé
                    // ÊàëÂÄëÁî®‰∏ÄÂÄãÁâπÊÆäÁöÑ Query: ÊâæÈÄôÂÄãÊúàÔºå‰∏î fixedItemId Á≠âÊñºÁï∂Ââç item.id ÁöÑ‰∫§Êòì
                    const snapshot = await db.collection('users').doc(userId.value).collection('transactions')
                        .where('fixedItemId', '==', item.id)
                        .where('date', '==', firstDayOfCurrentMonth)
                        .get();

                    if (snapshot.empty) {
                        // 3. Â¶ÇÊûúÊ≤íÊúâÔºåËá™ÂãïÁîüÊàê
                        console.log(`Auto-adding fixed item: ${item.category}`);
                        await db.collection('users').doc(userId.value).collection('transactions').add({
                            type: item.type,
                            amount: item.amount,
                            category: item.category,
                            account: 'Bank', // È†êË®≠ BankÔºå‰Ω†ÂèØ‰ª•Êîπ
                            date: firstDayOfCurrentMonth,
                            note: item.note || 'Auto Fixed',
                            fixedItemId: item.id // ÈóúÈçµÔºöÊ®ôË®òÈÄôÊòØÁî±Âì™ÂÄãË¶èÂâáÁîüÊàêÁöÑ
                        });
                    }
                }
            };

            let chart = null;
            const renderChart = async () => {
                if (categoryStats.value.length === 0) { if (chart) chart.destroy(); return; }
                
                chartKey.value++; 
                await nextTick(); 

                if (!chartRef.value) return;
                
                if (chart) {
                    chart.destroy();
                    chart = null;
                }

                const labels = categoryStats.value.map(s => s.name);
                const data = categoryStats.value.map(s => s.total);
                
                chart = new Chart(chartRef.value, {
                    type: 'doughnut',
                     { labels: labels, datasets: [{  data, backgroundColor: chartColors, borderWidth: 0 }] },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        animation: { animateScale: true, animateRotate: true, duration: 1000 },
                        plugins: { legend: { display: true, position: 'right', labels: { color: 'white', font: { size: 10 }, boxWidth: 10 } } }, 
                        cutout: '65%', 
                        layout: { padding: 10 } 
                    }
                });
            };

            const initAuth = () => auth.onAuthStateChanged(async user => { 
                if (user) { 
                    userId.value = user.uid; 
                    syncStatusColor.value = 'bg-green-500'; 
                    // Áõ£ËÅΩÊï∏Êìö
                    db.collection('users').doc(userId.value).collection('transactions').orderBy('date', 'desc').onSnapshot(s => transactions.value = s.docs.map(d => ({ id: d.id, ...d.data() })));
                    
                    // Áõ£ËÅΩÂõ∫ÂÆöÈ†ÖÁõÆÔºå‰∏¶Âú®ËºâÂÖ•ÂæåÂü∑Ë°åÊ™¢Êü•
                    db.collection('users').doc(userId.value).collection('fixedItems').onSnapshot(s => {
                        fixedItems.value = s.docs.map(d => ({ id: d.id, ...d.data() }));
                        // Áï∂Âõ∫ÂÆöÈ†ÖÁõÆÂàóË°®ËºâÂÖ•ÂÆåÊàêÂæåÔºåÂü∑Ë°å‰∏ÄÊ¨°Ëá™ÂãïÊ™¢Êü•
                        setTimeout(checkFixedItems, 2000); 
                    });
                } else { 
                    await auth.signInAnonymously(); 
                } 
            });

            onMounted(initAuth);
            
            watch(currentView, async (newView) => {
                if (newView === 'charts') {
                    const thisMonthRange = setFilterPreset('thisMonth');
                    const needUpdate = filterRange.value.start !== thisMonthRange.start || filterRange.value.end !== thisMonthRange.end;
                    
                    if (needUpdate) {
                        filterRange.value = thisMonthRange; 
                    } else {
                        await nextTick();
                        setTimeout(renderChart, 350); 
                    }
                }
            });
            
            watch([filterRange, transactions], async () => {
                if (currentView.value === 'charts') {
                    await nextTick();
                    setTimeout(renderChart, 350);
                }
            }, { deep: true });

            return {
                currentView, currentDate, selectedDate, transactions, accounts, categories, daysInMonth, filteredTransactions, dayTotal, 
                showFilterModal, filterRange, tempFilter, openFilterModal, applyFilter, setFilterPreset, formatDateRange, netWorthFiltered, categoryStats, transactionsInFilterRange,
                syncStatusColor, userId, showModal, isEditing, form, startDayOfWeek, chartColors, fixedItems, newFixed, currentYearMonthStr, displayUid, chartRef, totalExpenseFiltered, dailyAverage,
                chartKey, 
                changeMonth: (o) => { const d = new Date(currentDate.value); d.setMonth(d.getMonth() + o); currentDate.value = d; },
                selectDate: (d) => selectedDate.value = d,
                formatYearMonth: (d) => d.toLocaleString('default', { month: 'short', year: 'numeric' }),
                getCategoryIcon: (n) => categories.find(c => c.name === n)?.icon || 'üì¶',
                getAccountBalance: (n) => transactions.value.filter(t => t.account === n).reduce((s, t) => t.type === 'income' ? s + t.amount : s - t.amount, 0),
                onMonthPick: (e) => { const [y, m] = e.target.value.split('-'); currentDate.value = new Date(y, m - 1, 1); },
                openAddModal: () => { 
                    isEditing.value = false; 
                    form.value = { type: 'expense', amount: '', category: 'Food', account: 'Cash', date: selectedDate.value, note: '' }; 
                    showModal.value = true; 
                },
                editTransaction: (t) => { isEditing.value = true; editingId.value = t.id; form.value = { ...t }; showModal.value = true; },
                closeModal, saveTransaction, deleteTransaction, addFixedItem, removeFixedItem, dayClass: (d) => {
                    if (selectedDate.value === d.dateStr) return 'bg-[#FF9900] text-black border-black shadow-[2px_2px_0px_black]';
                    if (d.dateStr === getHKDate()) return 'border-[#FF9900] text-[#FF9900]';
                    return 'bg-[#262626] text-gray-300';
                }, hasTransaction: (d) => transactions.value.some(t => t.date === d), exportJSON, getHKDate
            };
        }
    }).mount('#app');
</script>
</body>
</html>
