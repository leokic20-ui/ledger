<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ledger.OS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- iOS PWA Setup -->
    <link rel="apple-touch-icon" href="icon.png"> 
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        body { background-color: #1a1a1a; color: #ffffff; font-family: ui-sans-serif, system-ui, -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .card-shadow { box-shadow: 4px 4px 0px 0px #000000; border: 2px solid #333333; }
        .accent-orange { color: #FF9900; }
        .bg-orange { background-color: #FF9900; }
        input, select { background: #262626; color: white; border: 2px solid #333333; outline: none; }
        input:focus { border-color: #FF9900; }
        .tab-active { color: #FF9900; transform: scale(1.1); }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden bg-[#1a1a1a]">

<div id="app" class="flex flex-col h-full w-full max-w-md mx-auto relative">

    <!-- HEADER -->
    <header class="p-4 flex justify-between items-center bg-[#1a1a1a] border-b-2 border-[#333333] z-10">
        <h1 class="text-xl font-black tracking-tighter">LEDGER<span class="text-[#FF9900]">.OS</span></h1>
        <div class="flex items-center gap-2">
            <div :class="syncStatusColor" class="w-2 h-2 rounded-full"></div>
            <span class="text-[10px] text-gray-500 font-mono">{{ userId ? userId.substring(0,6) : 'OFFLINE' }}</span>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-1 overflow-y-auto p-4 pb-28 no-scrollbar">
        
        <!-- CALENDAR VIEW -->
        <div v-if="currentView === 'calendar'" class="space-y-6">
            <div class="flex justify-between items-center bg-[#262626] p-3 rounded-lg card-shadow">
                <button @click="changeMonth(-1)" class="p-2 text-[#FF9900]">‚óÄ</button>
                <span class="font-bold text-lg">{{ formatYearMonth(currentDate) }}</span>
                <button @click="changeMonth(1)" class="p-2 text-[#FF9900]">‚ñ∂</button>
            </div>

            <div class="flex overflow-x-auto gap-3 pb-2 no-scrollbar">
                <div v-for="day in daysInMonth" :key="day.dateStr" 
                     @click="selectDate(day.dateStr)"
                     :class="['flex-shrink-0 w-14 h-16 flex flex-col items-center justify-center rounded-lg border-2 transition-all', 
                              selectedDate === day.dateStr ? 'bg-[#FF9900] border-[#FF9900] text-black font-bold card-shadow' : 'bg-[#262626] border-[#333333] text-gray-400']">
                    <span class="text-[10px] uppercase">{{ day.weekDay }}</span>
                    <span class="text-lg">{{ day.dayNum }}</span>
                </div>
            </div>

            <div class="space-y-3">
                <div class="flex justify-between items-end border-b-2 border-[#333333] pb-1">
                    <h2 class="text-sm font-bold text-gray-400 uppercase tracking-widest">{{ selectedDate }}</h2>
                    <span class="text-[#FF9900] font-mono font-bold text-lg">${{ dayTotal }}</span>
                </div>
                <div v-for="t in filteredTransactions" :key="t.id" @click="editTransaction(t)"
                     class="bg-[#262626] p-3 rounded-lg card-shadow flex justify-between items-center active:bg-[#333]">
                    <div class="flex items-center gap-3">
                        <span class="text-2xl">{{ getCategoryIcon(t.category) }}</span>
                        <div>
                            <div class="font-bold text-sm">{{ t.category }}</div>
                            <div class="text-[10px] text-gray-500">{{ t.account }} {{ t.note ? '‚Ä¢ ' + t.note : '' }}</div>
                        </div>
                    </div>
                    <div :class="['font-mono font-bold', t.type === 'expense' ? 'text-white' : 'text-[#FF9900]']">
                        {{ t.type === 'expense' ? '-' : '+' }}${{ t.amount }}
                    </div>
                </div>
            </div>
        </div>

        <!-- ACCOUNTS VIEW -->
        <div v-if="currentView === 'accounts'" class="space-y-4">
            <div class="bg-[#FF9900] text-black p-6 rounded-xl card-shadow">
                <div class="text-[10px] font-black uppercase tracking-[0.2em]">Total Balance</div>
                <div class="text-4xl font-black font-mono mt-1">${{ netWorth }}</div>
            </div>
            <div v-for="acc in accounts" :key="acc.name" class="bg-[#262626] p-4 rounded-lg card-shadow flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <span class="text-xl">{{ acc.icon }}</span>
                    <span class="font-bold">{{ acc.name }}</span>
                </div>
                <span class="font-mono text-lg">${{ acc.balance }}</span>
            </div>
        </div>

        <!-- CHARTS VIEW -->
        <div v-if="currentView === 'charts'" class="space-y-6">
            <div class="bg-[#262626] p-4 rounded-lg card-shadow h-64 relative">
                <canvas id="expenseChart"></canvas>
            </div>
            <div class="space-y-2">
                <div v-for="stat in categoryStats" :key="stat.name" class="flex justify-between items-center p-3 border-b border-[#333333]">
                    <div class="flex items-center gap-3">
                        <span>{{ stat.icon }}</span>
                        <span class="font-bold text-sm">{{ stat.name }}</span>
                    </div>
                    <div class="font-mono text-sm">${{ stat.total }} <span class="text-[#FF9900] ml-2">{{ stat.percent }}%</span></div>
                </div>
            </div>
        </div>

        <!-- SETTINGS VIEW -->
        <div v-if="currentView === 'settings'" class="space-y-4">
            <div class="bg-[#262626] p-4 rounded-lg card-shadow">
                <h3 class="text-[#FF9900] font-bold text-sm mb-3 uppercase">Backup & Privacy</h3>
                <button @click="exportJSON" class="w-full py-3 bg-[#333333] rounded font-bold text-sm mb-2">EXPORT JSON</button>
                <p class="text-[10px] text-gray-500 text-center mt-2">Data is synced to your private Firebase account.</p>
            </div>
        </div>

    </main>

    <!-- FAB -->
    <button @click="openAddModal" class="absolute bottom-24 right-6 w-14 h-14 bg-[#FF9900] rounded-full card-shadow flex items-center justify-center text-3xl font-black text-black z-20 active:scale-90 transition-transform">+</button>

    <!-- NAV -->
    <nav class="bg-[#1a1a1a] border-t-2 border-[#333333] h-20 flex justify-around items-center pb-4 z-10 text-[10px] font-black uppercase tracking-tighter">
        <button v-for="v in ['calendar', 'accounts', 'charts', 'settings']" @click="currentView = v" :class="currentView === v ? 'text-[#FF9900]' : 'text-gray-500'">
            <div class="text-xl mb-1">{{ {calendar:'üìÖ', accounts:'üí≥', charts:'üìä', settings:'‚öôÔ∏è'}[v] }}</div>{{ v }}
        </button>
    </nav>

    <!-- MODAL -->
    <div v-if="showModal" class="fixed inset-0 bg-black/90 z-50 flex items-end justify-center p-4 backdrop-blur-sm">
        <div class="bg-[#1a1a1a] w-full max-w-sm rounded-t-2xl border-t-4 border-[#FF9900] p-6 space-y-5 card-shadow">
            <div class="flex justify-between items-center">
                <h3 class="font-black text-lg">{{ isEditing ? 'EDIT' : 'NEW' }} RECORD</h3>
                <button @click="closeModal" class="text-2xl text-gray-500">√ó</button>
            </div>
            
            <div class="flex bg-[#262626] p-1 rounded-lg border-2 border-[#333]">
                <button @click="form.type = 'expense'" :class="['flex-1 py-2 rounded font-black', form.type === 'expense' ? 'bg-[#333] text-white' : 'text-gray-500']">EXPENSE</button>
                <button @click="form.type = 'income'" :class="['flex-1 py-2 rounded font-black', form.type === 'income' ? 'bg-[#333] text-[#FF9900]' : 'text-gray-500']">INCOME</button>
            </div>

            <input v-model.number="form.amount" type="number" class="w-full p-4 text-3xl font-mono font-bold rounded-lg text-center" placeholder="0.00" inputmode="decimal">

            <div class="grid grid-cols-4 gap-2">
                <button v-for="cat in categories" @click="form.category = cat.name" :class="['p-2 rounded border-2 transition-all', form.category === cat.name ? 'border-[#FF9900] bg-[#262626]' : 'border-transparent text-gray-500']">
                    <div class="text-xl">{{ cat.icon }}</div>
                    <div class="text-[8px] font-bold uppercase">{{ cat.name }}</div>
                </button>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <select v-model="form.account" class="p-3 rounded-lg font-bold text-xs uppercase">
                    <option v-for="acc in accounts" :value="acc.name">{{ acc.name }}</option>
                </select>
                <input v-model="form.date" type="date" class="p-3 rounded-lg font-mono text-xs">
            </div>

            <input v-model="form.note" type="text" class="w-full p-3 rounded-lg text-xs" placeholder="Notes...">

            <div class="flex gap-3 pt-2">
                <button v-if="isEditing" @click="deleteTransaction" class="flex-1 py-4 bg-red-900/20 text-red-500 font-black rounded-xl border-2 border-red-900">DEL</button>
                <button @click="saveTransaction" class="flex-[2] py-4 bg-[#FF9900] text-black font-black rounded-xl card-shadow uppercase">Confirm</button>
            </div>
        </div>
    </div>

</div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyAgQ5MJpg6r6fo94OWGgQVQcqa--awmNVY",
      authDomain: "my-ledger-app-3e089.firebaseapp.com",
      projectId: "my-ledger-app-3e089",
      storageBucket: "my-ledger-app-3e089.firebasestorage.app",
      messagingSenderId: "119116668732",
      appId: "1:119116668732:web:df7a535b9ec4b25a8ec839"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const { createApp, ref, computed, onMounted, watch } = Vue;

    createApp({
        setup() {
            const currentView = ref('calendar');
            const currentDate = ref(new Date());
            const selectedDate = ref(new Date().toISOString().split('T')[0]);
            const transactions = ref([]);
            const userId = ref(null);
            const syncStatusColor = ref('bg-red-500');
            const showModal = ref(false);
            const isEditing = ref(false);
            const editingId = ref(null);

            const accounts = ref([
                { name: 'Bank', icon: 'üè¶', balance: 0 },
                { name: 'Cash', icon: 'üíµ', balance: 0 },
                { name: 'Credit', icon: 'üí≥', balance: 0 },
                { name: 'Octopus', icon: 'üêô', balance: 0 }
            ]);

            const categories = [
                { name: 'Food', icon: 'üçî' }, { name: 'Transport', icon: 'üöå' },
                { name: 'Shopping', icon: 'üõçÔ∏è' }, { name: 'Ent.', icon: 'üé¨' },
                { name: 'Bills', icon: 'üßæ' }, { name: 'Salary', icon: 'üí∞' },
                { name: 'Travel', icon: '‚úàÔ∏è' }, { name: 'Other', icon: 'üì¶' }
            ];

            const form = ref({ type: 'expense', amount: '', category: 'Food', account: 'Cash', date: '', note: '' });

            const daysInMonth = computed(() => {
                const year = currentDate.value.getFullYear();
                const month = currentDate.value.getMonth();
                const days = new Date(year, month + 1, 0).getDate();
                return Array.from({length: days}, (_, i) => {
                    const d = new Date(year, month, i + 1);
                    return { dayNum: i + 1, weekDay: ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d.getDay()], dateStr: d.toISOString().split('T')[0] };
                });
            });

            const filteredTransactions = computed(() => transactions.value.filter(t => t.date === selectedDate.value));
            const dayTotal = computed(() => filteredTransactions.value.reduce((s, t) => t.type === 'expense' ? s - t.amount : s + t.amount, 0));
            const netWorth = computed(() => transactions.value.reduce((s, t) => t.type === 'income' ? s + t.amount : s - t.amount, 0));

            watch(transactions, () => {
                accounts.value.forEach(a => {
                    const plus = transactions.value.filter(t => t.account === a.name && t.type === 'income').reduce((s, t) => s + t.amount, 0);
                    const minus = transactions.value.filter(t => t.account === a.name && t.type === 'expense').reduce((s, t) => s + t.amount, 0);
                    a.balance = plus - minus;
                });
                if (currentView.value === 'charts') renderChart();
            }, { deep: true });

            const categoryStats = computed(() => {
                const s = {};
                transactions.value.filter(t => t.type === 'expense').forEach(t => { s[t.category] = (s[t.category] || 0) + t.amount; });
                const total = Object.values(s).reduce((a, b) => a + b, 0);
                return Object.entries(s).map(([n, v]) => ({ name: n, total: v, icon: categories.find(c => c.name === n).icon, percent: total ? Math.round(v/total*100) : 0 })).sort((a,b) => b.total - a.total);
            });

            const initAuth = () => {
                auth.onAuthStateChanged(async user => {
                    if (user) { userId.value = user.uid; syncStatusColor.value = 'bg-green-500'; loadData(); }
                    else { await auth.signInAnonymously(); }
                });
            };

            const loadData = () => {
                db.collection('users').doc(userId.value).collection('transactions').orderBy('date', 'desc')
                  .onSnapshot(s => { transactions.value = s.docs.map(d => ({ id: d.id, ...d.data() })); });
            };

            const saveTransaction = async () => {
                if (!form.value.amount) return;
                const d = { ...form.value };
                isEditing.value ? await db.collection('users').doc(userId.value).collection('transactions').doc(editingId.value).update(d)
                                : await db.collection('users').doc(userId.value).collection('transactions').add(d);
                closeModal();
            };

            const deleteTransaction = async () => {
                if (confirm("Delete?")) { await db.collection('users').doc(userId.value).collection('transactions').doc(editingId.value).delete(); closeModal(); }
            };

            let chart = null;
            const renderChart = () => {
                const ctx = document.getElementById('expenseChart');
                if (!ctx) return;
                if (chart) chart.destroy();
                chart = new Chart(ctx, {
                    type: 'doughnut',
                    data: { labels: categoryStats.value.map(s => s.name), datasets: [{ data: categoryStats.value.map(s => s.total), backgroundColor: ['#FF9900','#333','#555','#777','#999','#BBB','#DDD','#FFF'], borderWidth: 0 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, cutout: '75%' }
                });
            };

            onMounted(() => initAuth());
            watch(currentView, v => v === 'charts' && setTimeout(renderChart, 100));

            return {
                currentView, currentDate, selectedDate, transactions, accounts, categories, daysInMonth, filteredTransactions, dayTotal, netWorth, categoryStats, syncStatusColor, userId, showModal, isEditing, form,
                changeMonth: (o) => { const d = new Date(currentDate.value); d.setMonth(d.getMonth() + o); currentDate.value = d; },
                selectDate: (d) => selectedDate.value = d,
                formatYearMonth: (d) => d.toLocaleString('default', { month: 'short', year: 'numeric' }),
                getCategoryIcon: (n) => categories.find(c => c.name === n)?.icon || 'üì¶',
                openAddModal: () => { isEditing.value = false; form.value = { type: 'expense', amount: '', category: 'Food', account: 'Cash', date: selectedDate.value, note: '' }; showModal.value = true; },
                editTransaction: (t) => { isEditing.value = true; editingId.value = t.id; form.value = { ...t }; showModal.value = true; },
                closeModal: () => showModal.value = false,
                saveTransaction, deleteTransaction, exportJSON: () => { const b = new Blob([JSON.stringify(transactions.value, null, 2)], { type: "application/json" }); const a = document.createElement("a"); a.href = URL.createObjectURL(b); a.download = `ledger_backup.json`; a.click(); }
            };
        }
    }).mount('#app');
</script>
</body>
</html>
